# 要件定義書

## 概要

NotionのページIDを入力として、そのページ内の全てのブロックコンテンツを再帰的に取得し、構造化されたデータとして出力するツールを開発します。Notion APIの制限により、ページ直下のブロックしか取得できない問題を、再帰的なAPI呼び出しによって解決します。このツールは、プログラムから利用可能なライブラリと、コマンドラインから実行可能なCLIツールの両方の形式で提供されます。

## 要件

### 要件 1: Notionページコンテンツの完全取得

**ユーザーストーリー:** 開発者として、NotionページIDを指定して、ページ内の全てのブロックを階層構造を保ったまま取得したい。これにより、Notionページの完全な内容をプログラムで処理できるようになる。

#### 受け入れ条件

1. WHEN ページIDが提供された場合 THEN システムは Notion APIを使用してページ直下のブロックを取得する
2. WHEN 取得したブロックが子ブロックを持つ場合 THEN システムは再帰的にその子ブロックを取得する
3. WHEN 折りたたみブロック、リスト、テーブルなどのネストされたブロックが存在する場合 THEN システムは全ての階層のブロックを取得する
4. IF ブロックの取得に失敗した場合 THEN システムはエラーを適切に処理し、部分的な結果を返すか明確なエラーメッセージを提供する

### 要件 2: ライブラリとしての機能提供

**ユーザーストーリー:** 開発者として、TypeScript/JavaScriptプロジェクトから `fetchNotionPage` 関数を呼び出して、Notionページのデータを取得したい。これにより、自分のアプリケーションにNotion連携機能を組み込める。

#### 受け入れ条件

1. WHEN `fetchNotionPage(pageId, apiKey)` 関数が呼び出された場合 THEN システムは指定されたページの全ブロックを含むオブジェクトを返す
2. WHEN 関数が正常に実行された場合 THEN 返り値は型定義された構造化データである
3. IF APIキーが無効な場合 THEN システムは適切なエラーオブジェクトを返す
4. WHEN オプションパラメータが提供された場合 THEN システムは再帰の深さ制限、タイムアウト設定などの挙動をカスタマイズできる

### 要件 3: CLIツールとしての機能提供

**ユーザーストーリー:** ユーザーとして、コマンドラインから `fetch-notion-page [PAGE_ID]` を実行して、Notionページの内容をJSON形式で出力したい。これにより、スクリプトやパイプライン処理でNotionデータを活用できる。

#### 受け入れ条件

1. WHEN `fetch-notion-page [PAGE_ID]` コマンドが実行された場合 THEN システムは標準出力に`fetchNotionPage`関数の結果をJSON形式で出力する
2. IF 環境変数 `NOTION_API_KEY` が設定されている場合 THEN システムはそれを認証に使用する
3. WHEN `--api-key` オプションが指定された場合 THEN システムは環境変数よりもオプションの値を優先する
4. IF エラーが発生した場合 THEN システムは標準エラー出力に明確なエラーメッセージを表示し、適切な終了コードを返す

### 要件 4: パフォーマンスと信頼性

**ユーザーストーリー:** 開発者として、大規模なNotionページでも安定して動作するツールを使いたい。これにより、安定した本番環境での利用が可能になる。

#### 受け入れ条件

1. WHEN 多数のブロックを含むページを取得する場合 THEN システムは効率的に取得する
2. WHEN ページネーションが必要な場合 THEN システムは全てのページを自動的に取得する
3. IF ネットワークエラーが発生した場合 THEN システムは適切なエラーを返す
4. WHEN 再帰的な取得が実行される場合 THEN システムは無限ループを防ぐための深さ制限を適用する

### 要件 5: データ構造と型安全性

**ユーザーストーリー:** 開発者として、Notion APIのレスポンス構造を保ちつつ、階層構造を持つデータを型安全に扱いたい。これにより、Notion APIのドキュメントを参照しながら開発でき、開発時のエラーを防げる。

#### 受け入れ条件

1. WHEN ライブラリを使用する場合 THEN システムはTypeScriptの型定義を提供する
2. WHEN ブロックデータが返される場合 THEN Notion APIのレスポンス形式を維持しつつ、`children`プロパティに子ブロックが格納される
3. IF 子ブロックが存在する場合 THEN 各ブロックオブジェクトに`children`配列が追加され、階層構造が表現される
4. WHEN エラーが発生する場合 THEN エラーオブジェクトも型定義される